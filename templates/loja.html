{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="text-center mb-12">
        <h1 class="text-4xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
            Loja Codignarte
        </h1>
        <p class="text-gray-600 mt-2">Melhore sua experi√™ncia de aprendizado</p>
    </div>

    {% if premium %}
    <div class="bg-gradient-to-r from-premium to-yellow-400 text-yellow-900 rounded-2xl shadow-lg p-8 mb-8 text-center animate-fade-in">
        <div class="w-20 h-20 bg-yellow-800 bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-crown text-3xl"></i>
        </div>
        <h2 class="text-3xl font-bold mb-4">Voc√™ √© Premium! üéâ</h2>
        <p class="text-lg opacity-90 mb-4">
            Aproveite todos os benef√≠cios: vidas infinitas, √°udios das teorias e conte√∫dos exclusivos!
        </p>
        {% if current_user.data_expiracao_premium %}
        <p class="text-lg opacity-90 mb-6">
            Sua assinatura expira em: <strong>{{ current_user.data_expiracao_premium.strftime('%d/%m/%Y') }}</strong>
        </p>
        {% endif %}
        
        {% if status_reembolso %}
        <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-lg mb-4">
            <i class="fas fa-info-circle mr-2"></i>
            <strong>Status do Reembolso:</strong> {{ status_reembolso|upper }}
            <a href="{{ url_for('minhas_compras') }}" class="ml-2 text-blue-600 underline">Ver detalhes</a>
        </div>
        {% endif %}
        
        {% if pode_reembolso %}
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mb-4">
            <i class="fas fa-info-circle mr-2"></i>
            <strong>Direito a reembolso:</strong> Voc√™ pode cancelar e receber reembolso integral em at√© 7 dias.
        </div>
        {% endif %}
        
        <button onclick="mostrarModalCancelamento()" 
                class="bg-white text-premium px-6 py-3 rounded-lg hover:bg-gray-100 transition duration-150 font-semibold">
            <i class="fas fa-times mr-2"></i>Cancelar Assinatura
        </button>
    </div>
    {% endif %}

    <!-- Assinatura Premium -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
        <div class="bg-gradient-to-br from-premium to-yellow-600 text-white rounded-2xl shadow-2xl p-8 transform hover:scale-105 transition duration-300">
            <div class="text-center">
                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-crown text-2xl"></i>
                </div>
                <h2 class="text-3xl font-bold mb-4">Assinatura Premium</h2>
                <div class="text-5xl font-bold mb-6">R$ 13,49</div>
                <p class="text-xl opacity-90 mb-6">por 30 dias</p>
                
                <ul class="text-left space-y-3 mb-8">
                    <li class="flex items-center">
                        <i class="fas fa-infinity text-white mr-3"></i>
                        <span class="text-lg">Vidas infinitas</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-headphones text-white mr-3"></i>
                        <span class="text-lg">Teoria em √°udio</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-star text-white mr-3"></i>
                        <span class="text-lg">Conte√∫dos exclusivos</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-bolt text-white mr-3"></i>
                        <span class="text-lg">Sem espera por vidas</span>
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-shield-alt text-white mr-3"></i>
                        <span class="text-lg">Garantia de 7 dias</span>
                    </li>
                </ul>
                
                {% if premium %}
                <div class="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold">
                    <i class="fas fa-check mr-2"></i>Voc√™ j√° √© Premium!
                </div>
                {% else %}
                <button onclick="criarCheckoutAssinatura()" 
                        class="w-full bg-white text-yellow-600 px-8 py-4 rounded-xl hover:bg-gray-100 transition duration-150 font-semibold text-lg shadow-lg hover:shadow-xl">
                    <i class="fas fa-bolt mr-2"></i>Assinar Agora
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Pacotes de Vidas (apenas para n√£o premium) -->
        {% if not premium %}
        <div class="space-y-6">
            <div class="bg-white rounded-2xl shadow-lg p-6 text-center border-2 border-green-200 transform hover:scale-105 transition duration-300">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Pacote 1 Vida</h3>
                <div class="text-4xl font-bold text-success mb-4">R$ 0,99</div>
                <div class="flex justify-center mb-6">
                    <i class="fas fa-heart text-danger text-4xl"></i>
                </div>
                <button onclick="criarCheckoutVidas(1)" 
                        class="w-full bg-success text-white py-4 rounded-xl hover:bg-green-600 transition duration-150 font-semibold text-lg">
                    <i class="fas fa-shopping-cart mr-2"></i>Comprar
                </button>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6 text-center border-2 border-blue-200 transform hover:scale-105 transition duration-300">
                <div class="bg-primary text-white text-sm font-bold px-3 py-1 rounded-full inline-block mb-2">
                    Mais Popular
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Pacote 3 Vidas</h3>
                <div class="text-4xl font-bold text-primary mb-4">R$ 3,00</div>
                <div class="flex justify-center mb-6">
                    {% for i in range(3) %}
                    <i class="fas fa-heart text-danger text-3xl mx-1"></i>
                    {% endfor %}
                </div>
                <button onclick="criarCheckoutVidas(3)" 
                        class="w-full bg-primary text-white py-4 rounded-xl hover:bg-secondary transition duration-150 font-semibold text-lg">
                    <i class="fas fa-shopping-cart mr-2"></i>Comprar
                </button>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6 text-center border-2 border-purple-200 transform hover:scale-105 transition duration-300">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Pacote 5 Vidas</h3>
                <div class="text-4xl font-bold text-secondary mb-4">R$ 4,75</div>
                <div class="flex justify-center mb-6">
                    {% for i in range(5) %}
                    <i class="fas fa-heart text-danger text-2xl mx-1"></i>
                    {% endfor %}
                </div>
                <button onclick="criarCheckoutVidas(5)" 
                        class="w-full bg-secondary text-white py-4 rounded-xl hover:bg-purple-700 transition duration-150 font-semibold text-lg">
                    <i class="fas fa-shopping-cart mr-2"></i>Comprar
                </button>
            </div>
        </div>
        {% else %}
        <div class="bg-blue-50 border border-blue-200 rounded-2xl p-8 text-center">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-infinity text-blue-500 text-2xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-blue-800 mb-4">Vidas Infinitas!</h3>
            <p class="text-blue-600">
                Como usu√°rio Premium, voc√™ n√£o precisa se preocupar com vidas. 
                Estude √† vontade sem interrup√ß√µes!
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Modal de Cancelamento -->
    <div id="modalCancelamento" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Cancelar Assinatura</h3>
            
            <div class="mb-6">
                <label class="block text-gray-700 mb-2">Motivo do cancelamento (opcional):</label>
                <textarea id="motivoCancelamento" class="w-full border border-gray-300 rounded-lg p-3" 
                          placeholder="Nos conte o motivo do seu cancelamento..."></textarea>
            </div>

            {% if pode_reembolso %}
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                    <span class="text-green-700 font-semibold">Voc√™ tem direito a reembolso integral!</span>
                </div>
                <p class="text-green-600 text-sm mt-2">
                    Como sua assinatura tem menos de 7 dias, voc√™ receber√° o valor total de volta.
                </p>
            </div>
            {% else %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                    <span class="text-yellow-700 font-semibold">Fora do prazo de reembolso</span>
                </div>
                <p class="text-yellow-600 text-sm mt-2">
                    Sua assinatura tem mais de 7 dias. Voc√™ manter√° os benef√≠cios at√© o fim do ciclo.
                </p>
            </div>
            {% endif %}

            <div class="flex space-x-4">
                <button onclick="fecharModalCancelamento()" 
                        class="flex-1 border border-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-50 transition duration-150">
                    Voltar
                </button>
                <button onclick="confirmarCancelamento()" 
                        class="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition duration-150 font-semibold">
                    Confirmar Cancelamento
                </button>
            </div>
        </div>
    </div>

    <!-- Informa√ß√µes de Reembolso -->
    <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Rastreamento de Reembolsos</h2>
        
        <div class="grid md:grid-cols-4 gap-4 text-center mb-6">
            <div class="p-4">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-search text-blue-500"></i>
                </div>
                <h4 class="font-semibold text-gray-800 mb-1">Localize sua Compra</h4>
                <p class="text-gray-600 text-sm">Acesse "Minhas Compras" e encontre o ID da transa√ß√£o</p>
            </div>
            
            <div class="p-4">
                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-sync-alt text-green-500"></i>
                </div>
                <h4 class="font-semibold text-gray-800 mb-1">Status em Tempo Real</h4>
                <p class="text-gray-600 text-sm">Acompanhe cada etapa do processamento</p>
            </div>
            
            <div class="p-4">
                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-bell text-purple-500"></i>
                </div>
                <h4 class="font-semibold text-gray-800 mb-1">Notifica√ß√µes Autom√°ticas</h4>
                <p class="text-gray-600 text-sm">Receba atualiza√ß√µes via Stripe Webhook</p>
            </div>
            
            <div class="p-4">
                <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-history text-orange-500"></i>
                </div>
                <h4 class="font-semibold text-gray-800 mb-1">Hist√≥rico Completo</h4>
                <p class="text-gray-600 text-sm">Veja todo o hist√≥rico de processamento</p>
            </div>
        </div>

        <div class="text-center">
            <a href="{{ url_for('minhas_compras') }}" 
               class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-secondary transition duration-150 font-semibold inline-flex items-center">
                <i class="fas fa-receipt mr-2"></i> Acessar Minhas Compras
            </a>
        </div>
    </div>

    <!-- Seguran√ßa Stripe -->
    <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Pagamento 100% Seguro</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
            <div class="p-4">
                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-shield-alt text-green-500 text-xl"></i>
                </div>
                <h3 class="font-semibold text-gray-800 mb-2">Processado pelo Stripe</h3>
                <p class="text-gray-600 text-sm">Pagamentos seguros com criptografia de n√≠vel banc√°rio</p>
            </div>
            
            <div class="p-4">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-credit-card text-blue-500 text-xl"></i>
                </div>
                <h3 class="font-semibold text-gray-800 mb-2">Dados Protegidos</h3>
                <p class="text-gray-600 text-sm">Seus dados de pagamento nunca s√£o armazenados em nossos servidores</p>
            </div>
            
            <div class="p-4">
                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-lock text-purple-500 text-xl"></i>
                </div>
                <h3 class="font-semibold text-gray-800 mb-2">Certificado SSL</h3>
                <p class="text-gray-600 text-sm">Conex√£o segura e criptografada em toda a plataforma</p>
            </div>
        </div>
        
        <div class="mt-6 text-center">
            <img src="https://stripe.com/img/v3/home/twitter.png" alt="Stripe" class="h-8 mx-auto opacity-50">
            <p class="text-sm text-gray-500 mt-2">Processamento de pagamentos por Stripe</p>
        </div>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
const stripePublicKey = '{{ stripe_public_key }}';

function mostrarModalCancelamento() {
    document.getElementById('modalCancelamento').classList.remove('hidden');
}

function fecharModalCancelamento() {
    document.getElementById('modalCancelamento').classList.add('hidden');
}

async function confirmarCancelamento() {
    const motivo = document.getElementById('motivoCancelamento').value;
    
    try {
        const response = await fetch('/cancelar_assinatura', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ motivo: motivo })
        });
        
        const data = await response.json();
        
        if (data.success) {
            fecharModalCancelamento();
            
            if (data.reembolsado) {
                alert('‚úÖ ' + data.message);
            } else {
                alert('‚ÑπÔ∏è ' + data.message);
            }
            
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            alert('‚ùå Erro: ' + data.error);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro ao cancelar assinatura. Tente novamente.');
    }
}

// Fun√ß√£o para criar checkout de assinatura
async function criarCheckoutAssinatura() {
    try {
        const response = await fetch('/criar-sessao-assinatura', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.checkout_url) {
            window.location.href = data.checkout_url;
        } else {
            alert('Erro: ' + data.error);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao processar a compra. Tente novamente.');
    }
}

// Fun√ß√£o para criar checkout de vidas
async function criarCheckoutVidas(quantidade) {
    try {
        const response = await fetch(`/criar-sessao-vidas/${quantidade}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.checkout_url) {
            window.location.href = data.checkout_url;
        } else {
            alert('Erro: ' + data.error);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao processar a compra. Tente novamente.');
    }
}
</script>

<style>
.rotate-180 {
    transform: rotate(180deg);
}
</style>
{% endblock %}