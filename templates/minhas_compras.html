{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
            Minhas Compras
        </h1>
        <p class="text-gray-600 mt-2">Histórico completo de suas transações e reembolsos</p>
    </div>

    {% if transacoes %}
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-800">Histórico de Transações</h2>
            <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-bold">
                {{ transacoes|length }} transações
            </span>
        </div>

        <div class="space-y-4">
            {% for transacao in transacoes %}
            <div class="border border-gray-200 rounded-2xl p-6 hover:shadow-lg transition duration-150">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-4">
                        {% if transacao.status == 'confirmada' %}
                        <div class="w-12 h-12 bg-success rounded-full flex items-center justify-center">
                            <i class="fas fa-check text-white"></i>
                        </div>
                        {% elif transacao.status == 'reembolsada' %}
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-undo text-white"></i>
                        </div>
                        {% else %}
                        <div class="w-12 h-12 bg-warning rounded-full flex items-center justify-center">
                            <i class="fas fa-clock text-white"></i>
                        </div>
                        {% endif %}
                        
                        <div>
                            <h3 class="font-semibold text-gray-800 text-lg">{{ transacao.detalhes }}</h3>
                            <p class="text-gray-600 text-sm">
                                {{ transacao.data_transacao.strftime('%d/%m/%Y às %H:%M') }}
                            </p>
                            
                            <!-- Informações de uso do produto -->
                            {% if transacao.tipo.startswith('vidas_') %}
                            <div class="mt-2">
                                <div class="flex items-center space-x-2 text-sm text-gray-600">
                                    <span>Vidas compradas: {{ transacao.quantidade_produto }}</span>
                                    <span>•</span>
                                    <span>Utilizadas: {{ transacao.quantidade_utilizada }}</span>
                                    <span>•</span>
                                    <span class="font-semibold {% if transacao.quantidade_produto - transacao.quantidade_utilizada > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                        Restantes: {{ transacao.quantidade_produto - transacao.quantidade_utilizada }}
                                    </span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="text-right">
                        <div class="text-2xl font-bold text-gray-800">R$ {{ "%.2f"|format(transacao.valor) }}</div>
                        <div class="text-sm text-gray-500">
                            {% if transacao.tipo == 'assinatura' %}Assinatura Premium
                            {% elif transacao.tipo == 'vidas_1' %}1 Vida
                            {% elif transacao.tipo == 'vidas_3' %}3 Vidas
                            {% elif transacao.tipo == 'vidas_5' %}5 Vidas
                            {% else %}{{ transacao.tipo }}{% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4 text-sm mb-4">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <strong class="text-gray-700">ID da Compra:</strong>
                        <div class="flex items-center justify-between mt-1">
                            <code class="text-gray-600 font-mono">{{ transacao.id_publico }}</code>
                            <button onclick="copiarId('{{ transacao.id_publico }}')" 
                                    class="text-primary hover:text-secondary">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <strong class="text-gray-700">Status:</strong>
                        <span class="ml-2 px-2 py-1 rounded-full text-xs font-bold
                            {% if transacao.status == 'confirmada' %}bg-success bg-opacity-20 text-success
                            {% elif transacao.status == 'reembolsada' %}bg-blue-100 text-blue-800
                            {% else %}bg-warning bg-opacity-20 text-warning{% endif %}">
                            {% if transacao.status == 'confirmada' %}Confirmada
                            {% elif transacao.status == 'reembolsada' %}Reembolsada
                            {% else %}Pendente{% endif %}
                        </span>
                    </div>
                </div>

                <!-- Status do Reembolso -->
                {% if transacao.status_reembolso != 'nao_solicitado' %}
                <div class="border-t pt-4">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-semibold text-gray-700">Status do Reembolso:</h4>
                        <span class="px-3 py-1 rounded-full text-xs font-bold
                            {% if transacao.status_reembolso == 'completado' %}bg-green-100 text-green-800
                            {% elif transacao.status_reembolso == 'processando' %}bg-blue-100 text-blue-800
                            {% elif transacao.status_reembolso == 'solicitado' %}bg-yellow-100 text-yellow-800
                            {% elif transacao.status_reembolso == 'falhou' %}bg-red-100 text-red-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ transacao.status_reembolso|upper }}
                        </span>
                    </div>

                    {% if transacao.valor_reembolsado > 0 %}
                    <div class="bg-green-50 p-3 rounded-lg mb-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <strong class="text-green-700">Valor do Reembolso:</strong>
                                <p class="text-green-600 font-semibold">R$ {{ "%.2f"|format(transacao.valor_reembolsado) }}</p>
                            </div>
                            {% if transacao.valor_reembolsado < transacao.valor %}
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-bold">
                                Reembolso Parcial
                            </span>
                            {% else %}
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-bold">
                                Reembolso Total
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if transacao.stripe_refund_id %}
                    <div class="bg-blue-50 p-3 rounded-lg mb-3">
                        <strong class="text-blue-700">ID do Reembolso Stripe:</strong>
                        <div class="flex items-center justify-between mt-1">
                            <code class="text-blue-600 font-mono text-sm">{{ transacao.stripe_refund_id }}</code>
                            <button onclick="copiarId('{{ transacao.stripe_refund_id }}')" 
                                    class="text-blue-500 hover:text-blue-700">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    {% endif %}

                    <div class="flex justify-between items-center">
                        <div>
                            {% if transacao.data_solicitacao_reembolso %}
                            <p class="text-sm text-gray-600">
                                <strong>Solicitado em:</strong> 
                                {{ transacao.data_solicitacao_reembolso.strftime('%d/%m/%Y às %H:%M') }}
                            </p>
                            {% endif %}
                            
                            {% if transacao.data_processamento_reembolso %}
                            <p class="text-sm text-gray-600">
                                <strong>Processado em:</strong> 
                                {{ transacao.data_processamento_reembolso.strftime('%d/%m/%Y às %H:%M') }}
                            </p>
                            {% endif %}
                        </div>
                        
                        <a href="{{ url_for('detalhes_transacao', id_publico=transacao.id_publico) }}" 
                           class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary transition duration-150 text-sm font-semibold">
                            <i class="fas fa-search mr-1"></i> Ver Detalhes
                        </a>
                    </div>
                </div>
                {% endif %}

                <!-- Botão de Reembolso -->
                {% if transacao.status == 'confirmada' and transacao.status_reembolso == 'nao_solicitado' %}
                <div class="border-t pt-4 mt-4">
                    {% if transacao.pode_reembolsar() %}
                        {% if transacao.tipo == 'assinatura' %}
                        <button onclick="solicitarReembolsoAssinatura('{{ transacao.id_publico }}')" 
                                class="w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600 transition duration-150 font-semibold">
                            <i class="fas fa-undo mr-2"></i>Solicitar Reembolso Total (CDC 7 Dias)
                        </button>
                        {% elif transacao.tipo.startswith('vidas_') %}
                        <button onclick="solicitarReembolsoVidas('{{ transacao.id_publico }}')" 
                                class="w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600 transition duration-150 font-semibold">
                            <i class="fas fa-undo mr-2"></i>Solicitar Reembolso Proporcional
                        </button>
                        {% endif %}
                    {% else %}
                        {% if transacao.tipo == 'assinatura' %}
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-center">
                            <p class="text-red-700 text-sm">
                                <i class="fas fa-info-circle mr-1"></i>
                                Reembolso não disponível: {% if transacao.produto_utilizado %}Benefícios premium já utilizados{% else %}Prazo de 7 dias expirado{% endif %}
                            </p>
                        </div>
                        {% elif transacao.tipo.startswith('vidas_') %}
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-center">
                            <p class="text-red-700 text-sm">
                                <i class="fas fa-info-circle mr-1"></i>
                                Reembolso não disponível: 
                                {% if transacao.quantidade_utilizada >= transacao.quantidade_produto %}
                                Todas as vidas já foram utilizadas
                                {% else %}
                                Prazo de 7 dias expirado
                                {% endif %}
                            </p>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="bg-white rounded-2xl shadow-lg p-8 text-center">
        <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-shopping-cart text-gray-400 text-3xl"></i>
        </div>
        <h3 class="text-2xl font-semibold text-gray-600 mb-2">Nenhuma compra encontrada</h3>
        <p class="text-gray-500 mb-6">Você ainda não realizou nenhuma compra em nossa plataforma.</p>
        <a href="{{ url_for('loja') }}" 
           class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-secondary transition duration-150 font-semibold inline-block">
            <i class="fas fa-store mr-2"></i>Ir para a Loja
        </a>
    </div>
    {% endif %}

    <!-- Sistema de Rastreamento -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Política de Reembolso - CDC Artigo 49</h2>
        
        <div class="grid md:grid-cols-3 gap-6 mb-6">
            <div class="text-center p-4">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-calendar-check text-green-500 text-xl"></i>
                </div>
                <h3 class="font-semibold text-gray-800 mb-2">7 Dias para Arrependimento</h3>
                <p class="text-gray-600 text-sm">Direito garantido pelo Código de Defesa do Consumidor</p>
            </div>
            
            <div class="text-center p-4">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-calculator text-blue-500 text-xl"></i>
                </div>
                <h3 class="font-semibold text-gray-800 mb-2">Reembolso Proporcional</h3>
                <p class="text-gray-600 text-sm">Valor calculado baseado no uso do produto</p>
            </div>
            
            <div class="text-center p-4">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-shield-alt text-purple-500 text-xl"></i>
                </div>
                <h3 class="font-semibold text-gray-800 mb-2">100% Legal</h3>
                <p class="text-gray-600 text-sm">Sistema totalmente compliant com a legislação</p>
            </div>
        </div>
    </div>

    <!-- Informações sobre Reembolso -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Como Funciona o Reembolso</h2>
        
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <h3 class="font-semibold text-green-800 mb-3 flex items-center">
                    <i class="fas fa-crown mr-2"></i>Assinatura Premium
                </h3>
                <ul class="text-green-700 text-sm space-y-2">
                    <li class="flex items-start">
                        <i class="fas fa-check mt-1 mr-2 text-green-500"></i>
                        <span><strong>Reembolso Total:</strong> Dentro de 7 dias sem uso</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-times mt-1 mr-2 text-red-500"></i>
                        <span><strong>Sem Reembolso:</strong> Após 7 dias ou se usou benefícios</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-info mt-1 mr-2 text-blue-500"></i>
                        <span>Cancelamento mantém benefícios até o fim do ciclo</span>
                    </li>
                </ul>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="font-semibold text-blue-800 mb-3 flex items-center">
                    <i class="fas fa-heart mr-2"></i>Pacotes de Vidas
                </h3>
                <ul class="text-blue-700 text-sm space-y-2">
                    <li class="flex items-start">
                        <i class="fas fa-calculator mt-1 mr-2 text-blue-500"></i>
                        <span><strong>Reembolso Proporcional:</strong> Baseado nas vidas não usadas</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-times mt-1 mr-2 text-red-500"></i>
                        <span><strong>Sem Reembolso:</strong> Se usou todas as vidas</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-info mt-1 mr-2 text-blue-500"></i>
                        <span>Dentro do prazo legal de 7 dias</span>
                    </li>
                </ul>
            </div>
        </div>
        
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h3 class="font-semibold text-yellow-800 mb-2 flex items-center">
                <i class="fas fa-exclamation-triangle mr-2"></i>Importante sobre Taxas
            </h3>
            <p class="text-yellow-700 text-sm">
                As taxas de processamento da Stripe (2.9% + R$ 0,30 por transação) não são reembolsáveis, 
                conforme política da plataforma de pagamentos. Nos reembolsos proporcionais de vidas, 
                este valor já é considerado no cálculo.
            </p>
        </div>
    </div>
</div>

<!-- Modal para Reembolso de Vidas -->
<div id="modalReembolsoVidas" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
        <h3 class="text-2xl font-bold text-gray-800 mb-4">Solicitar Reembolso de Vidas</h3>
        
        <div id="infoReembolsoVidas" class="mb-6">
            <!-- As informações serão preenchidas via JavaScript -->
        </div>

        <div class="mb-6">
            <label class="block text-gray-700 mb-2">Motivo do reembolso (opcional):</label>
            <textarea id="motivoReembolsoVidas" class="w-full border border-gray-300 rounded-lg p-3" 
                      placeholder="Nos conte o motivo do seu reembolso..."></textarea>
        </div>

        <div class="flex space-x-4">
            <button onclick="fecharModalReembolsoVidas()" 
                    class="flex-1 border border-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-50 transition duration-150">
                Cancelar
            </button>
            <button onclick="confirmarReembolsoVidas()" 
                    class="flex-1 bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 transition duration-150 font-semibold">
                Confirmar Reembolso
            </button>
        </div>
    </div>
</div>

<!-- Modal para Reembolso de Assinatura -->
<div id="modalReembolsoAssinatura" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
        <h3 class="text-2xl font-bold text-gray-800 mb-4">Solicitar Reembolso de Assinatura</h3>
        
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
            <div class="flex items-center">
                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                <span class="text-green-700 font-semibold">Reembolso Total Disponível!</span>
            </div>
            <p class="text-green-600 text-sm mt-2">
                Como sua assinatura tem menos de 7 dias, você receberá o valor integral de volta.
            </p>
        </div>

        <div class="mb-6">
            <label class="block text-gray-700 mb-2">Motivo do reembolso (opcional):</label>
            <textarea id="motivoReembolsoAssinatura" class="w-full border border-gray-300 rounded-lg p-3" 
                      placeholder="Nos conte o motivo do seu reembolso..."></textarea>
        </div>

        <div class="flex space-x-4">
            <button onclick="fecharModalReembolsoAssinatura()" 
                    class="flex-1 border border-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-50 transition duration-150">
                Cancelar
            </button>
            <button onclick="confirmarReembolsoAssinatura()" 
                    class="flex-1 bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 transition duration-150 font-semibold">
                Confirmar Reembolso
            </button>
        </div>
    </div>
</div>

<script>
let transacaoVidasAtual = null;
let transacaoAssinaturaAtual = null;

function copiarId(id) {
    navigator.clipboard.writeText(id).then(function() {
        // Feedback visual
        const btn = event.target;
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.classList.remove('text-primary');
        btn.classList.add('text-green-500');
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('text-green-500');
            btn.classList.add('text-primary');
        }, 2000);
    });
}

function solicitarReembolsoVidas(idPublico) {
    transacaoVidasAtual = idPublico;
    
    // Buscar informações da transação
    fetch(`/detalhes-transacao/${idPublico}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const transacao = data.transacao;
                const vidasNaoUtilizadas = transacao.quantidade_produto - transacao.quantidade_utilizada;
                const valorReembolso = transacao.valor_reembolsado;
                
                document.getElementById('infoReembolsoVidas').innerHTML = `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <strong class="text-blue-700">Vidas Compradas:</strong>
                                <p class="text-blue-600">${transacao.quantidade_produto}</p>
                            </div>
                            <div>
                                <strong class="text-blue-700">Vidas Utilizadas:</strong>
                                <p class="text-blue-600">${transacao.quantidade_utilizada}</p>
                            </div>
                            <div>
                                <strong class="text-blue-700">Vidas Restantes:</strong>
                                <p class="text-blue-600 font-semibold">${vidasNaoUtilizadas}</p>
                            </div>
                            <div>
                                <strong class="text-blue-700">Valor do Reembolso:</strong>
                                <p class="text-blue-600 font-semibold">R$ ${valorReembolso.toFixed(2)}</p>
                            </div>
                        </div>
                        <p class="text-blue-600 text-xs mt-2">
                            * Valor já considera as taxas da Stripe não reembolsáveis
                        </p>
                    </div>
                `;
                
                document.getElementById('modalReembolsoVidas').classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao buscar informações da transação.');
        });
}

function solicitarReembolsoAssinatura(idPublico) {
    transacaoAssinaturaAtual = idPublico;
    document.getElementById('modalReembolsoAssinatura').classList.remove('hidden');
}

function fecharModalReembolsoVidas() {
    document.getElementById('modalReembolsoVidas').classList.add('hidden');
    transacaoVidasAtual = null;
}

function fecharModalReembolsoAssinatura() {
    document.getElementById('modalReembolsoAssinatura').classList.add('hidden');
    transacaoAssinaturaAtual = null;
}

function confirmarReembolsoVidas() {
    const motivo = document.getElementById('motivoReembolsoVidas').value || 'Arrependimento do usuário';
    
    fetch(`/solicitar-reembolso-vidas/${transacaoVidasAtual}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ motivo: motivo })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ ' + data.message);
            fecharModalReembolsoVidas();
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            alert('❌ Erro: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('❌ Erro ao solicitar reembolso. Tente novamente.');
    });
}

function confirmarReembolsoAssinatura() {
    const motivo = document.getElementById('motivoReembolsoAssinatura').value || 'Arrependimento do usuário';
    
    fetch(`/cancelar_assinatura`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ motivo: motivo })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ ' + data.message);
            fecharModalReembolsoAssinatura();
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            alert('❌ Erro: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('❌ Erro ao solicitar reembolso. Tente novamente.');
    });
}
</script>
{% endblock %}